<link rel="import" href="../tangere/tangere.html" />
<link rel="import" href="../at-theme/at-theme.html" />
<link rel="import" href="../at-carbon-icon/at-carbon-icon.html" />
<link rel="import" href="../at-carbon-button/at-carbon-button.html" />
<link rel="import" href="../at-core-dropdown/at-core-dropdown.html" />
<link rel="import" href="../at-carbon-menu/at-carbon-menu.html" />
<link rel="import" href="../at-link/at-link.html">

<dom-module id="at-carbon-button-menu">
  <template>
    <style>
       :host {
        display: block;
        box-sizing: border-box;
      }

      .relative {
        position: relative;
        height: 50px;
      }

      .absolute {
        position: absolute;
      }

      .arrow-icon-container {
        vertical-align: middle;
      }

      .arrow-icon {
        width: var(--at-inline-icon-size);
        height: var(--at-inline-icon-size);
      }

      .button-label {
        @apply(--paper-font-body1);
        vertical-align: middle;
      }

      .button-label.with-icon {
        margin-left: 8px;
      }

      .icon-class {
        padding: 0 12px 0 0;
      }

      .title-class {
        vertical-align: middle;        
        overflow: hidden;
        white-space: nowrap;
      }
    </style>
    <div class="relative">
      <div class="absolute">
        <at-carbon-button raised id="carbonButton">
          <template is="dom-if" if="[[icon]]">
            <at-carbon-icon icon="[[icon]]"></at-carbon-icon>
          </template>
          <span class$="[[_computeLabelClassList(icon)]]">[[label]]</span>
          <span class="arrow-icon-container"><at-carbon-icon id="arrowIcon" icon="now:caret-up" class="arrow-icon" hidden$="{{!items.length}}"></at-carbon-icon></span>
        </at-carbon-button>
        <at-core-dropdown id="coreDropdown" y-offset="1" on-open-changed="_handleOpenChanged" position="[[position]]">
          <at-carbon-menu id="carbonMenu" items="[[items]]" item-view="[[itemView]]" on-tap="_handleMenuOnTap"></at-carbon-menu>
        </at-core-dropdown>
      </div>
    </div>
    <at-link id="link" style="display:none"></at-link>
  </template>
</dom-module>
<script>
  Polymer({
    is: "at-carbon-button-menu",
    properties: {

      icon: {
        type: String,
        value: ""
      },

      label: {
        type: String,
        value: ""
      },

      items: {
        type: Array,
        value: function() { return []; },
        schema: {
          items: {
            properties: {
              title: {
                type: String,
                title: "Title",
                "default": ""
              },
              value: {
                type: String,
                title: "Value",
                "default": ""
              },
              icon: {
                type: String,
                title: "Icon",
                "default": ""
              }
            }
          }
        },
        xgridcols: "12"
      },

      itemView: {
        type: String,
        xtype: 'code',
        mode: 'liquidmixed',
        value: '<div><at-carbon-icon icon="{{icon}}" class="icon-class at-carbon-button-menu"></at-carbon-icon><span class="title-class at-carbon-button-menu">{{title}}</span></div>',
        xgridcols: "12"
      },

      position: {
        type: String,
        value: "bottomLeft",
        xtype: "enum",
        xvaluelist: [{
          title: "Top Left",
          value: "topLeft"
        }, {
          title: "Top Right",
          value: "topRight"
        }, {
          title: "Bottom Left",
          value: "bottomLeft"
        }, {
          title: "Bottom Right",
          value: "bottomRight"
        }]
      },
      
      selectMode: {
        type: String,
        value: "event",
        xtype: "enum",
        xvaluelist: [{
          title: "fire click event",
          value: "event"
        }, {
          title: "open value as link",
          value: "link"
        }]
      },

    },

    listeners: {
      'carbonButton.tap': '_handleCarbonButtonOnTap'
    },

    _computeLabelClassList: function(icon) {
      var result = ['button-label'];
      if (icon) { result.push('with-icon'); }
      return result.join(" ");
    },

    _handleCarbonButtonOnTap: function(event) {
      // if there are no menu items return
      if (!this.items.length) { return; }

      // toggle dropdown
      if (this.$.coreDropdown.open) {
        this.$.coreDropdown.hide();
      } else {
        this.$.coreDropdown.show(event, this.$.carbonButton);
      }
    },

    _handleMenuOnTap: function(event) {
      this.$.coreDropdown.hide();

      var value = this.$.carbonMenu.value;
      
      if(this.selectMode == "event") {
        this.fire('clicked', { value: value });
      } else {
        // selectMode link means that values contain links
        // use hidden link to open these links
        // *todo* create mixin for link handling
        for(var idx=0;idx<this.items.length;idx++) {  
          var link = this.items[idx];      
         
          if(link.value==value) {
            this.$.link.href = link.value;
            this.$.link.label = link.title;
            this.$.link._handleLink();
          }
          this.$.carbonMenu.value=""; // reset selection
        }
      }
    },

    _handleOpenChanged: function() {
      this.$.arrowIcon.icon = this.$.coreDropdown.open ? "now:caret-up" : "now:caret-down";;
    },

    ready: function() {

    }
  });
</script>
