<link rel="import" href="../tangere/tangere.html" />
<link rel="import" href="../at-carbon-icon/at-carbon-icon.html" />
<link rel="import" href="../at-carbon-button/at-carbon-button.html" />
<link rel="import" href="../at-core-dropdown/at-core-dropdown.html" />
<link rel="import" href="../at-carbon-menu/at-carbon-menu.html" />

<dom-module id="at-carbon-button-menu">
  <template>
    <style>
       :host {
        display: block;
        box-sizing: border-box;
      }

      .relative {
        position: relative;
        height: 50px;
      }

      .absolute {
        position: absolute;
      }

      .button-label {
        @apply(--paper-font-body1);
        vertical-align: middle;
      }

      .button-label.with-icon {
        margin-left: 8px;
      }
    </style>
    <div class="relative">
      <div class="absolute">
        <at-carbon-button raised id="carbonButton">
          <template is="dom-if" if="[[icon]]">
            <at-carbon-icon icon="[[icon]]"></at-carbon-icon>
          </template>
          <span class$="[[_computeLabelClassList(icon)]]">[[label]]</span>
          <at-carbon-icon id="arrowIcon" icon="now:arrow-up" disabled$="{{!items.length}}"></at-carbon-icon>
        </at-carbon-button>
        <at-core-dropdown id="coreDropdown" y-offset="1" on-open-changed="_handleOpenChanged" position="[[position]]">
          <at-carbon-menu id="carbonMenu" items="[[items]]" item-view="[[itemView]]" on-tap="_handleMenuOnTap"></at-carbon-menu>
        </at-core-dropdown>
      </div>
    </div>
  </template>
</dom-module>
<script>
  Polymer({
    is: "at-carbon-button-menu",
    properties: {

      icon: {
        type: String,
        value: ""
      },

      label: {
        type: String,
        value: ""
      },

      items: {
        type: Array,
        value: function() { return []; },
        schema: {
          items: {
            properties: {
              title: {
                type: String,
                title: "Title",
                "default": ""
              },
              value: {
                type: String,
                title: "Value",
                "default": ""
              },
              icon: {
                type: String,
                title: "Icon",
                "default": ""
              }
            }
          }
        },
        xgridcols: "12"
      },

      itemView: {
        type: String,
        xtype: 'code',
        mode: 'liquidmixed',
        value: '<div><at-carbon-icon icon="{{icon}}" class="icon-class at-carbon-button-menu"></at-carbon-icon><span class="title-class at-carbon-button-menu">{{title}}</span></div>',
        xgridcols: "12"
      },

      position: {
        type: String,
        value: "bottomLeft",
        xtype: "enum",
        xvaluelist: [{
          title: "Top Left",
          value: "topLeft"
        }, {
          title: "Top Right",
          value: "topRight"
        }, {
          title: "Bottom Left",
          value: "bottomLeft"
        }, {
          title: "Bottom Right",
          value: "bottomRight"
        }]
      },

    },

    listeners: {
      'carbonButton.tap': '_handleCarbonButtonOnTap'
    },

    _computeLabelClassList: function(icon) {
      var result = ['button-label'];
      if (icon) { result.push('with-icon'); }
      return result.join(" ");
    },

    _handleCarbonButtonOnTap: function(event) {
      // if there are no menu items return
      if (!this.items.length) { return; }

      // toggle dropdown
      if (this.$.coreDropdown.open) {
        this.$.coreDropdown.hide();
      } else {
        this.$.coreDropdown.show(event, this.$.carbonButton);
      }
    },

    _handleMenuOnTap: function(event) {
      this.$.coreDropdown.hide();

      var value = this.$.carbonMenu.value;
      // TODO @Temporary right now value of clicked item is passed; this may not be adequate
      this.fire('menu-item-clicked', { value: value });
    },

    _handleOpenChanged: function() {
      this.$.arrowIcon.icon = this.$.coreDropdown.open ? "now:arrow-up" : "now:arrow-down";;
    },

    ready: function() {

    }
  });
</script>
